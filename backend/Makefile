.DEFAULT_GOAL := help

# NoteFlow Backend - Docker Management
.PHONY: help build up down logs clean dev prod db-only

# Default target
help: ## Show this help message
	@echo "NoteFlow Backend - Docker Commands"
	@echo "=================================="
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Development Commands
dev: ## Start development environment with hot reload
	@echo "ğŸš€ Starting development environment..."
	docker-compose up -d
	@echo "âœ… Development environment started!"
	@echo "ğŸ“ Backend: http://localhost:3000"
	@echo "ğŸ“ GraphQL: http://localhost:3000/graphql"

dev-logs: ## Show development logs
	docker-compose logs -f

dev-down: ## Stop development environment
	@echo "ğŸ›‘ Stopping development environment..."
	docker-compose down
	@echo "âœ… Development environment stopped!"

# Database Only Commands  
db-only: ## Start only database services (PostgreSQL + Redis)
	@echo "ğŸ—„ï¸ Starting database services..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "âœ… Database services started!"
	@echo "ğŸ“ PostgreSQL: localhost:5432"
	@echo "ğŸ“ Redis: localhost:6379"

db-logs: ## Show database logs
	docker-compose -f docker-compose.dev.yml logs -f

db-down: ## Stop database services
	@echo "ğŸ›‘ Stopping database services..."
	docker-compose -f docker-compose.dev.yml down
	@echo "âœ… Database services stopped!"

# Production Commands
prod: ## Start production environment
	@echo "ğŸ­ Starting production environment..."
	docker-compose -f docker-compose.prod.yml up -d
	@echo "âœ… Production environment started!"

prod-build: ## Build production images
	@echo "ğŸ”¨ Building production images..."
	docker-compose -f docker-compose.prod.yml build
	@echo "âœ… Production images built!"

prod-logs: ## Show production logs
	docker-compose -f docker-compose.prod.yml logs -f

prod-down: ## Stop production environment
	@echo "ğŸ›‘ Stopping production environment..."
	docker-compose -f docker-compose.prod.yml down
	@echo "âœ… Production environment stopped!"

# Build Commands
build: ## Build development images
	@echo "ğŸ”¨ Building development images..."
	docker-compose build
	@echo "âœ… Development images built!"

build-no-cache: ## Build images without cache
	@echo "ğŸ”¨ Building images without cache..."
	docker-compose build --no-cache
	@echo "âœ… Images built without cache!"

# Database Commands
migrate: ## Run database migrations
	@echo "ğŸ”„ Running database migrations..."
	docker exec noteflow-backend npm run db:migrate || npm run db:migrate
	@echo "âœ… Database migrations completed!"

migrate-prod: ## Run production database migrations
	@echo "ğŸ”„ Running production database migrations..."
	docker exec noteflow-backend-prod npm run db:deploy
	@echo "âœ… Production database migrations completed!"

studio: ## Open Prisma Studio
	@echo "ğŸ¨ Opening Prisma Studio..."
	npm run db:studio

seed: ## Seed database with sample data
	@echo "ğŸŒ± Seeding database..."
	docker exec noteflow-backend npm run db:seed || npm run db:seed
	@echo "âœ… Database seeded!"

# Utility Commands
logs: ## Show all logs
	docker-compose logs -f

ps: ## Show running containers
	@echo "ğŸ“‹ Running containers:"
	docker-compose ps

exec: ## Execute bash in backend container
	docker exec -it noteflow-backend sh

exec-db: ## Connect to PostgreSQL database
	docker exec -it noteflow-postgres psql -U znotes -d znotes

backup: ## Backup database
	@echo "ğŸ’¾ Creating database backup..."
	docker exec noteflow-postgres pg_dump -U znotes znotes > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Database backup created!"

restore: ## Restore database from backup (Usage: make restore FILE=backup.sql)
	@echo "ğŸ”„ Restoring database from $(FILE)..."
	docker exec -i noteflow-postgres psql -U znotes -d znotes < $(FILE)
	@echo "âœ… Database restored!"

clean: ## Clean up Docker resources
	@echo "ğŸ§¹ Cleaning up Docker resources..."
	docker system prune -f
	docker volume prune -f
	@echo "âœ… Docker resources cleaned!"

clean-all: ## Remove all containers, images, and volumes
	@echo "ğŸ§¹ Removing all Docker resources..."
	docker-compose down -v --rmi all
	docker-compose -f docker-compose.dev.yml down -v --rmi all
	docker-compose -f docker-compose.prod.yml down -v --rmi all
	docker system prune -af
	@echo "âœ… All Docker resources removed!"

# Status Commands
status: ## Show status of all services
	@echo "ğŸ“Š Service Status:"
	@echo "=================="
	@docker-compose ps 2>/dev/null || echo "Development stack: Not running"
	@docker-compose -f docker-compose.dev.yml ps 2>/dev/null || echo "Database services: Not running"
	@docker-compose -f docker-compose.prod.yml ps 2>/dev/null || echo "Production stack: Not running"

health: ## Check health of services
	@echo "ğŸ¥ Health Check:"
	@echo "================"
	@curl -f http://localhost:3000/health 2>/dev/null && echo "âœ… Backend: Healthy" || echo "âŒ Backend: Unhealthy"
	@docker exec noteflow-postgres pg_isready -U znotes 2>/dev/null && echo "âœ… PostgreSQL: Ready" || echo "âŒ PostgreSQL: Not ready"
	@docker exec noteflow-redis redis-cli ping 2>/dev/null && echo "âœ… Redis: Connected" || echo "âŒ Redis: Not connected"

# Setup Commands
setup: ## Initial setup for development
	@echo "ğŸ”§ Setting up development environment..."
	@cp .env.example .env 2>/dev/null || echo ".env already exists"
	@echo "ğŸ“¦ Installing dependencies..."
	@npm install
	@echo "ğŸ—„ï¸ Starting database services..."
	@make db-only
	@echo "â³ Waiting for database to be ready..."
	@sleep 10
	@echo "ğŸ”„ Running migrations..."
	@make migrate
	@echo "âœ… Development environment setup complete!"
	@echo ""
	@echo "Next steps:"
	@echo "1. Edit .env file with your configuration"
	@echo "2. Run 'make dev' to start the full development stack"
	@echo "3. Or run 'npm run start:dev' to start backend locally"

init: ## Initialize project (alias for setup)
	@make setup
